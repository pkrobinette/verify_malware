#
# Use the pytorch image
#
FROM pytorch/pytorch:2.1.1-cuda12.1-cudnn8-runtime

# Set the non-root user information
ARG USER=user
ARG UID=1000
ARG GID=1000

# Create a non-root user
RUN groupadd -g $GID $USER \
    && useradd -u $UID -g $GID -m -s /bin/bash $USER

# Give sudo privileges to the non-root user
RUN apt-get update && apt-get install -y sudo \
    && echo "$USER ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/$USER \
    && chmod 0440 /etc/sudoers.d/$USER

# Set the working directory
WORKDIR /home/$USER

# Install dependencies
RUN sudo apt-get update \
    && sudo apt-get install -y python3 pip git \
    && sudo rm -rf /var/lib/apt/lists/* \
    && python3 -m pip install --upgrade pip \
    && sudo chown -R $USER:$USER /home/$USER

# Copy artifact files to the container
COPY --chown=$USER:$USER . /home/$USER/verify_malware

# Clone nnenum repository
RUN git clone https://github.com/stanleybak/nnenum /home/$USER/nnenum

# Install Python dependencies
RUN python3 -m pip install -r /home/$USER/verify_malware/requirements.txt \
    && python3 -m pip install -r /home/$USER/nnenum/requirements.txt

# Set execution permissions for scripts
RUN chmod +x /home/$USER/nnenum/run_tests.sh \
    && chmod +x /home/$USER/verify_malware/verify/nnenum_verify/run_subset_nnenum.sh \
    && chmod +x /home/$USER/verify_malware/scripts/run_nnenum.sh \
    && chmod +x /home/$USER/verify_malware/scripts/run_results.sh \
    && chmod +x /home/$USER/verify_malware/scripts/run_nnenum_smoke.sh

# Set environment variables
ENV PYTHONPATH=$PYTHONPATH:/home/$USER/nnenum/src
ENV OPENBLAS_NUM_THREADS=1
ENV OMP_NUM_THREADS=1
ENV PATH="/opt/conda/bin:${PATH}"

# Switch to the non-root user
USER $USER

# Set the entry point to run your script
CMD cd verify_malware && "./scripts/run_nnenum_smoke.sh"