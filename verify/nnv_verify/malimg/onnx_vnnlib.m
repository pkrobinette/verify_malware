%% Script to verify malware properties

% Select network to verify
modelName = "malware_malimg_family_scaled_linear-25.onnx";
netonnx = importONNXNetwork("../../../models/malimg/add_softmax/"+modelName, "InputDataFormats", "BCSS", "OutputDataFormats","BC");

% transform into NNV
net = matlab2nnv(netonnx);

N = 125;
% Define reachability options
reachOptions.reachMethod = 'relax-star-area';
reachOptions.relaxFactor = 0.5;
results = zeros(N);

% vnnlib_file = "../../../image0.vnnlib";
% t = tic;
% res = net.verify_vnnlib(vnnlib_file, reachOptions);
% if res~= 1 && res ~= 0
%     reachOptions = struct;
%     reachOptions.reachMethod = 'approx-star';
%     res = net.verify_vnnlib(vnnlib_file, reachOptions);
% end
% 
% disp(res);

% Verify network
for i=1:N
    % print statements
    if mod(i, 10) == 0
        disp("Verifying example:  "+string(i));
        disp("Robust = "+string(sum(res(:)==1))+" out of " + string(i-1) + " images");
    end
    % select vnnlib file
    vnnlib_file = '/Users/probinet/Documents/PROJECTS/foramliSE_malware/vnnlib/malimg/malimg_1_' + string(i) + '.vnnlib';
    t = tic;
    % verify with relax star
    res = net.verify_vnnlib(vnnlib_file, reachOptions);
    % if unknown, try approx-star
    if res ~= 1 && res ~= 0
        reachOptions = struct;
        reachOptions.reachMethod = 'approx-star';
        res = net.verify_vnnlib(vnnlib_file, reachOptions);
    end
    % record results
    results(i) = res;
end