function [data, labels, mal_key] = read_imgs(N)
% Loads N images (normalized) from each class of the malimg dataset 

    path = "../../../archive/malimg_dataset/validation_resize/";

    files = dir(path);
    mal_dirs = [files.isdir];
    mal_dirs = files(mal_dirs);
    mal_key = {mal_dirs(3:end).name};

    % Initial estimates (will be adjusted later)
    estNumImages = length(mal_key) * N; 
    data = zeros(64, 64, 1, estNumImages);
    labels = zeros(1, estNumImages);

    totalImages = 0;

    for i = 1:length(mal_key)
        mal_path = path+mal_key{i};
        allImgList = dir(fullfile(mal_path, '*.png'));
        %
        % Get rid of macOS silent images
        %
        imgList = {};
        for k = 1:length(allImgList)
            filename = allImgList(k).name;
            % Check if the filename does not start with ._
            if ~startsWith(filename, '._')
                imgList{end + 1} = allImgList(k);
            end
        end

        % Limit the number of images read per class to N
        numImagesToRead = min(N, length(imgList));
        for j = 1:numImagesToRead
            im = imread(fullfile(mal_path, imgList{j}.name));
            im = double(im)./255;

            totalImages = totalImages + 1;
            
            % Check if resizing is needed
            if totalImages > size(data, 4)
                data = cat(4, data, zeros(64, 64, 1, estNumImages - size(data, 4)));
                labels = cat(2, labels, zeros(1, estNumImages - size(labels, 2)));
            end

            data(:, :, 1, totalImages) = im;
            labels(:, totalImages) = i;
        end
    end

    % Trim the excess elements
    data = data(:, :, 1, 1:totalImages);
    labels = labels(:, 1:totalImages);
end
