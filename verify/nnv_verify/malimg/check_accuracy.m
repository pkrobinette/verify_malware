%% Verify the model accuracy for all images
% linear ~90%
% 4-25 ~94%
% 16-25 ~94%

disp("Running MALIMG analysis...");

% List of trained models
models = ["malware_malimg_family_scaled_linear-25.onnx";
    "malware_malimg_family_scaled_4-25.onnx";
    "malware_malimg_family_scaled_16-25.onnx"];
numClasses = 25;

% Load data
rng(2); % set random seed fix
[XData, YData, KeyData] = read_imgs_all();

% Verify every model
for ms = 1:length(models)

    % Load model
    modelName = models(ms);
    saveName = split(modelName,'.');
    saveName = saveName{1};
    netonnx = importONNXNetwork("../../../models/malimg/"+modelName, "InputDataFormats", "BCSS", "OutputDataFormats","BC");
    net = matlab2nnv(netonnx); % convert to NNV
    net.OutputSize = numClasses;
    disp("Running model:  "+saveName);
    predictedLabels = predict(netonnx, XData);
    [~, predictedLabels] = max(predictedLabels, [], 2);
    wrong = 0;
    right = 0;
    for i = 1:length(predictedLabels)
        if predictedLabels(i) == YData(i)
            right = right + 1;
        else
            wrong = wrong + 1;
        end
    end

    % Results
    disp("========  RESULTS ========");
    disp("");
    disp("Accuracy: "+string(right/(right + wrong)));
end

